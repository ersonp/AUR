# Maintainer: Moses Narrow <moe_narrow@use.startmail.com>
# Maintainer: Rudi [KittyCash] <rudi@skycoinmail.com>
pkgname=skycoin-latest
pkgname1=skycoin
projectname=skycoin
githuborg=SkycoinProject
pkgdesc="Skycoin Cryptocurrency Wallet ; latest commits"
pkgver='autogenerated'
#pkgver='autogenerated'
pkggopath="github.com/${githuborg}/${pkgname1}"
pkgrel=2
#pkgrel=2
arch=('any')
url="https://${pkggopath}"
license=()
provides=(${pkgname1})
makedepends=(git go skycoin-keyring)
source=("git+${url}.git#branch=${BRANCH:-develop}"
"${pkgname1}-scripts.tar.gz"
"${pkgname1}-systemd.tar.gz"
"PKGBUILD.sig")
sha256sums=('SKIP'
            '373f79da7ee2360fbe2587ecbcf432851e395d746ddd6ad3de0b10bc452535c3'
            '241e97bd523a0680e119ebb2543feaea1f13cf9127b3371c9175d64b986c6985'
            'SKIP')
validpgpkeys=('DE08F924EEE93832DABC642CA8DC761B1C0C0CFC'  # Moses Narrow <moe_narrow@use.startmail.com>
                           '98F934F04F9334B81DFA3398913BBD5206B19620') #iketheadore skycoin <luxairlake@protonmail.com>


case "$CARCH" in
x86)      export GOARCH="386" GO386="387" ;;
x86_64)   export GOARCH="amd64" ;;
arm*)     export GOARCH="arm" ;;
armel)    export GOARCH="arm" GOARM="5" ;;
armhf)    export GOARCH="arm" GOARM="6" ;;
armv7)    export GOARCH="arm" GOARM="7" ;;
armv8)    export GOARCH="arm64" ;;
aarch64)  export GOARCH="arm64" ;;
mips)     export GOARCH="mips" ;;
mips64)   export GOARCH="mips64" ;;
mips64el) export GOARCH="mips64le" ;;
mipsel)   export GOARCH="mipsle" ;;
*)        return 1 ;;
	esac

	pkgver() {
		cd "${srcdir}/${pkgname1}"
		local date=$(git log -1 --format="%cd" --date=short | sed s/-//g)
		local count=$(git rev-list --count HEAD)
		local commit=$(git rev-parse --short HEAD)
		echo "$date.${count}_$commit"
	}

prepare() {
	#gpg --import key
	#verify PKGBUILD signature
	gpg --verify ${srcdir}/PKGBUILD.sig ../PKGBUILD
	# https://wiki.archlinux.org/index.php/Go_package_guidelines
	mkdir -p ${srcdir}/go/src/github.com/${githuborg}/ ${srcdir}/go/bin
	ln -rTsf ${srcdir}/${pkgname1} ${srcdir}/go/src/${pkggopath}
	cd ${srcdir}/go/src/${pkggopath}/cmd
	git submodule --quiet update --init --recursive
	export GOPATH="${srcdir}"/go
	export GOBIN=${GOPATH}/bin
	export PATH=${GOPATH}/bin:${PATH}
	#msg2 'installing go dependencies'
	#dep init
	#dep ensure
}

build() {
	export GOPATH="${srcdir}"/go
	export GOBIN=${GOPATH}/bin
	export PATH=${GOPATH}/bin:${PATH}
	cmddir=${srcdir}/go/src/github.com/${githuborg}/${pkgname1}/cmd
  #using go build for determinism
	cd ${cmddir}/address_gen
	msg2 'building skycoin-address_gen binary'
  go build -trimpath -ldflags '-extldflags ${LDFLAGS}' -ldflags=-buildid= -o $GOBIN/ .
  cd ${cmddir}/cipher-testdata
	msg2 'building skycoin-cipher-testdata binary'
  go build -trimpath -ldflags '-extldflags ${LDFLAGS}' -ldflags=-buildid= -o $GOBIN/ .
  cd ${cmddir}/monitor-peers
	msg2 'building skycoin-monitor-peers binary'
  go build -trimpath -ldflags '-extldflags ${LDFLAGS}' -ldflags=-buildid= -o $GOBIN/ .
  cd ${cmddir}/newcoin
	msg2 'building skycoin-newcoin binary'
	go build -trimpath -ldflags '-extldflags ${LDFLAGS}' -ldflags=-buildid= -o $GOBIN/ .
  cd ${cmddir}/skycoin-cli
  msg2 'building skycoin-cli binary'
	go build -trimpath -ldflags '-extldflags ${LDFLAGS}' -ldflags=-buildid= -o $GOBIN/ .
  cd ${cmddir}/skycoin
	msg2 'building skycoin binary'
  go build -trimpath -ldflags '-extldflags ${LDFLAGS}' -ldflags=-buildid= -o $GOBIN/ .
	#binary transparency
	cd $GOBIN
	msg2 'binary sha256sums'
	sha256sum $(ls)
}

package() {
	options=(!strip staticlibs)
	#create directory trees
	mkdir -p ${pkgdir}/usr/bin
	mkdir -p ${pkgdir}/usr/lib/${projectname}/go/bin
	mkdir -p ${pkgdir}/usr/lib/${projectname}/${pkgname1}/src/gui
	#install binaries & symlink to /usr/bin
	msg2 'installing binaries'
	skybin="${srcdir}"/go/bin
	#avoid generic names for binaries
	#collect the binaries & install
	skybins=$( ls "$skybin")
	for i in $skybins; do
		install -Dm755 ${srcdir}/go/bin/${i} ${pkgdir}/usr/lib/${projectname}/go/bin/${i}
		ln -rTsf ${pkgdir}/usr/lib/${projectname}/go/bin/$i ${pkgdir}/usr/bin/${i}
		chmod 755 ${pkgdir}/usr/bin/${i}
	done
	#install the web dir (UI)
	cp -r ${srcdir}/${pkgname1}/src/gui/static ${pkgdir}/usr/lib/${projectname}/${pkgname1}/src/gui
	#install the scripts
	cd ${srcdir}/${pkgname1}-scripts/
	skycoinscripts=$( ls )
	for i in $skycoinscripts; do
		install -Dm755 ${srcdir}/${pkgname1}-scripts/${i} ${pkgdir}/usr/lib/${projectname}/go/bin/${i}
		ln -rTsf ${pkgdir}/usr/lib/${projectname}/go/bin/${i} ${pkgdir}/usr/bin/${i}
	done
	#correct symlink names
	cd ${pkgdir}/usr/bin/
	namechange=$(ls --ignore='skycoin*')
	for i in $namechange; do
		mv ${pkgdir}/usr/bin/${i} ${pkgdir}/usr/bin/${pkgname1}-${i}
	done
	#install the system.d service
	cd ${srcdir}/${pkgname1}-systemd/
	skycoinservices=$( ls )
	for i in $skycoinservices; do
	install -Dm644 ${srcdir}/${pkgname1}-systemd/${i} ${pkgdir}/usr/lib/systemd/system/${i}
done
}
