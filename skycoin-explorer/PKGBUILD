# Maintainer: Moses Narrow <moe_narrow@use.startmail.com>
# Maintainer: Rudi [KittyCash] <rudi@skycoinmail.com>
_projectname=skycoin
_pkgname=${_projectname}-explorer
pkgname=${_pkgname}
_githuborg=${_projectname}
pkgdesc="Skycoin Blockchain Explorer. https://explorer.skycoin.com/"
pkgver=20190520.559_8cf0521
#pkgver='autogenerated'
pkgrel=1
#pkgrel=5
_pkggopath="github.com/${_githuborg}/${_pkgname}"
arch=('any')
url="https://${_pkggopath}"
license=()
makedepends=('git' 'go' 'musl' 'kernel-headers-musl' 'npm' 'node-gyp' 'angular-cli')
depends=('skycoin')
source=("git+${url}.git#branch=${BRANCH:-master}")
sha256sums=('SKIP')
#validpgpkeys=('DE08F924EEE93832DABC642CA8DC761B1C0C0CFC')  # Moses Narrow <moe_narrow@use.startmail.com>
#                           '98F934F04F9334B81DFA3398913BBD5206B19620') #iketheadore skycoin <luxairlake@protonmail.com>

pkgver() {
  cd "${srcdir}/${pkgname}"
  local date=$(git log -1 --format="%cd" --date=short | sed s/-//g)
  local count=$(git rev-list --count HEAD)
  local commit=$(git rev-parse --short HEAD)
  echo "${date}.${count}_${commit}"
}

prepare() {
  #verify PKGBUILD signature
  #gpg --verify ${srcdir}/PKGBUILD.sig ../PKGBUILD
  mkdir -p ${srcdir}/go/src/github.com/${_githuborg}/ ${srcdir}/go/bin
  ln -rTsf ${srcdir}/${_pkgname} ${srcdir}/go/src/${_pkggopath}
}

build () {
#  _msg2 'installing go dependencies'
export GOPATH=${srcdir}/go
export GOBIN=${GOPATH}/bin
export CC=musl-gcc
export CGO_ENABLED=1
cd ${srcdir}/go/src/${_pkggopath}/
npm install
npm install node-sass
npm run build
go build -trimpath --ldflags '-linkmode external -extldflags "-static" -buildid=' -o $GOBIN/ .
#binary transparency
cd $GOBIN
_msg2 'binary sha256sums'
sha256sum $(ls)
}


package() {
#  options=(!strip staticlibs)
  #create directory trees
  mkdir -p ${pkgdir}/usr/bin
  mkdir -p ${pkgdir}/opt/${_pkgname}/bin
  #install binaries & symlink to /usr/bin
  msg2 'installing binaries'
  install -Dm755 ${GOBIN}/${_pkgname} ${pkgdir}/opt/${_pkgname}/bin/${_pkgname}
  ln -rTsf ${pkgdir}/opt/${_pkgname}/bin/${_pkgname} ${pkgdir}/usr/bin/${_pkgname}
  chmod 755 ${pkgdir}/usr/bin/${_pkgname}
}


_msg2() {
(( QUIET )) && return
local mesg=$1; shift
printf "${BLUE}  ->${ALL_OFF}${BOLD} ${mesg}${ALL_OFF}\n" "$@"
}
